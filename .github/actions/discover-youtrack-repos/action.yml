name: Discover Repositories from YouTrack Ticket
description: Analyze a YouTrack ticket with AI agent and emit a JSON list of accessible repositories

inputs:
  ticket-id:
    description: 'YouTrack ticket ID'
    required: true
  ticket-title:
    description: 'YouTrack ticket title'
    required: true
  ticket-description:
    description: 'YouTrack ticket description'
    required: true
  github-organization:
    description: 'GitHub organization to check for repositories'
    required: true

runs:
  using: composite
  steps:
    - name: Build Discovery Prompt
      shell: bash
      run: |
        cat >>"$GITHUB_ENV" <<'EOF'
        PROMPT<<__PROMPT__
        Ticket ID: ${{ inputs.ticket-id }}
        Title: ${{ inputs.ticket-title }}
        Description: ${{ inputs.ticket-description }}

        Task:
        Find repositories that are EXPLICITLY mentioned in the ticket title or description text.

        What counts as explicit mention:
        - Direct repo names: "simple-todo", "user-service", "api-gateway"
        - Repository lists: "repositories: repo1, repo2" or "repos: repo1, repo2"
        - GitHub URLs: "https://github.com/org/repo-name"
        - Specific references: "update the simple-todo repository"

        What does NOT count:
        - General statements like "update the frontend" or "fix the API"
        - Vague references without specific repository names
        - Assumptions about what might need changes

        Instructions:
        - ONLY return repositories that are explicitly named in the ticket text
        - Validate accessibility in the ${{ inputs.github-organization }} org using gh
        - If NO repositories are explicitly mentioned or none of the repos are accessible return empty array
        - Respond with JSON only (no prose, no code fences) in the exact shape:
          { "repositories": ["org/repo", ...] }
        - If none explicitly found, return { "repositories": [] }
        __PROMPT__
        EOF

    - id: ai
      name: Discover Repositories with AI Agent
      shell: bash
      run: |
        set -euo pipefail
        echo "Running OpenCode with prompt..."
        echo "Environment variables:"
        echo "OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:0:10}..." >&2
        echo "Prompt length: ${#PROMPT}" >&2

        # Run opencode and capture output and exit code
        # Save prompt to file to avoid shell escaping issues
        echo "$PROMPT" > /tmp/opencode_prompt.txt

        set +e
        RESPONSE=$(opencode run "$(cat /tmp/opencode_prompt.txt)" 2>&1)
        EXIT_CODE=$?
        set -e

        rm -f /tmp/opencode_prompt.txt

        echo "OpenCode exit code: $EXIT_CODE" >&2
        echo "Raw AI response: $RESPONSE" >&2

        if [ $EXIT_CODE -ne 0 ]; then
          echo "OpenCode failed with exit code $EXIT_CODE" >&2
          echo "Full output: $RESPONSE" >&2
          exit $EXIT_CODE
        fi

        # Extract JSON from response (handles both clean JSON and mixed output with tool logs)
        # Look for last occurrence of {"repositories": pattern
        JSON_LINE=$(printf '%s' "$RESPONSE" | grep -o '{"repositories":\[.*\]}' | tail -n1)
        if [ -n "$JSON_LINE" ]; then
          REPOS_JSON=$(echo "$JSON_LINE" | jq -c '.repositories // []' 2>/dev/null || echo '[]')
        else
          REPOS_JSON='[]'
        fi
        echo "Extracted repositories JSON: $REPOS_JSON" >&2
        # Expose as step output for the composite action
        echo "repositories=$REPOS_JSON" >> "$GITHUB_OUTPUT"

outputs:
  repositories:
    description: 'Discovered repositories as a JSON array string (e.g., ["org/repo"])'
    value: ${{ steps.ai.outputs.repositories }}
